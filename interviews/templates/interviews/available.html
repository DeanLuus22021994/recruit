{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/7.0.0/css/bootstrap-slider.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-switch/3.3.2/css/bootstrap3/bootstrap-switch.min.css">
<style>
	thead th {
		text-align: center;
	}
	thead th:nth-child(1) {
		text-align: right;
	}	
	td {
		text-align: center;
	}
	.slider-selection {
		background: #CCC;
	}
</style>
<meta name="csrf-token" content="{{csrf_token}}">
{% endblock %}

{% block content %}

<div class="row">
	<div class='col-md-offset-2 col-md-8'>
		<div class='row'>
			<h1>{{ user.first_name }}'s Availability</h1>
			<ul class="list-group">
				 <li class="list-group-item list-group-item-info">
				 	<div class='row'>
						<div class='col-xs-12 col-sm-4'>Timezone:
						</div>
						<div class='col-xs-12 col-sm-8'>
							<div id='timezoneDiv'>
								<select id='timezoneMenu'>
								</select>
							</div>
							<small>*Timezone not correct? Select from menu.</small>
						</div>
					</div>
				 </li>
			</ul>
		</div>
		<div class='row'>
			<table class="table">
			  	<thead>
			 		<tr>
			 			<!-- <th>Day</th> -->
			 			<th>Available?</th>
			 			<th>Time</th>
			 			<th><small>*Slide to adjust time range</small></th>
			 		</tr>
			 	</thead>
			 <tbody>
			 	<tr>
			 		<th style='width: 35%'>Monday
			 		<span class='pull-right'>
			 			<input class='monday' type='checkbox'>
					</span>
			 		</th>
			 		<td>
						<span id='mondayTime' class='time'></span>
					</td>
					<td>
							<input class='slideInput' id="monday" type="text"/>
					</td>
				</tr>
				<tr>
					<th>Tuesday
					<span class='pull-right'>
			 			<input class='tuesday' type='checkbox'>
					</span>
			 		</th>
					<td>
						<span id='tuesdayTime' class='time'></span>
					</td>
					<td>	
							<input class='slideInput' id="tuesday" type="text"/>
					</td>
				</tr>
				<tr>
					<th>Wednesday
					<span class='pull-right'>
			 			<input class='wednesday' type='checkbox'>
					</span>
			 	</th>
					<td>
						<span id='wednesdayTime' class='time'></span>
					</td>
					<td>	
							<input class='slideInput' id="wednesday" type="text"/>
					</td>
				</tr>
				<tr>
					<th>Thursday
					<span class='pull-right'>
			 			<input class='thursday' type='checkbox'>
					</span>
			 	</th>
					<td>
						<span id='thursdayTime' class='time'></span>
					</td>
					<td>	
							<input class='slideInput' id="thursday" type="text"/>
					</td>
				</tr>
				<tr>
					<th>Friday
					<span class='pull-right'>
			 			<input class='friday' type='checkbox'>
					</span>
			 		</th>
					<td>
						<span id='fridayTime' class='time'></span>
					</td>
					<td>	
							<input class='slideInput' id="friday" type="text"/>
					</td>
				</tr>			
				<tr>
					<th>Saturday
				<span class='pull-right'>
			 			<input class='saturday' type='checkbox'>
					</span>
			 	</th>
					<td>
						<span id='saturdayTime' class='time'></span>
					</td>
					<td>	
							<input class='slideInput' id="saturday" type="text"/>
					</td>
				</tr>
				<tr>
					<th>Sunday
					<span class='pull-right'>
			 			<input class='sunday' type='checkbox'>
					</span>
			 	</th>
					<td>
						<span id='sundayTime' class='time'></span>
					</td>
					<td>	
						<input class='slideInput' id="sunday" type="text" disable/>
					</td>
				</tr>	
			</tbody>

			</table>
		</div>
		<div class='row text-center'>
			<button id='updateBtn' type="button" class="btn btn-success btn-lg">Update Availability</button>
		</div>

	</div>
<span id='storedTz' style='display: none'>{{ user.timezone }}</span>
</div>
{% endblock %}


{% block scripts %}
{{ block.super }}
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/7.0.0/bootstrap-slider.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-switch/3.3.2/js/bootstrap-switch.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.3/moment-timezone-with-data-2010-2020.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jstimezonedetect/1.0.6/jstz.min.js"></script>
<script type="text/javascript">

$(document).ready(function() {

	var DAYS_OF_WEEK = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

	var checkboxes = $("[type='checkbox']");
	checkboxes.attr('data-size', 'mini');
	checkboxes.attr('data-on-text', 'Yes');
	checkboxes.attr('data-off-text', 'No');
	checkboxes.bootstrapSwitch();

	$('input[type="checkbox"]').on('switchChange.bootstrapSwitch', function(event, state) {

		var day = event.target.className;
		var daySlider = $('input[type="text"]#' + day);
		var timeSpan = $('span#' + day + 'Time');
		var slideInput = $('#' + day + '.slideInput');

		if (state) {
			daySlider.slider("enable");
			timeSpan.removeClass('hide');
			slideInput.addClass('inputOn');
		} else {
			daySlider.slider("disable");
			timeSpan.addClass('hide');
			slideInput.removeClass('inputOn');
		}

	});

	function formatTime(time) {
		var period = 'am';
		var time = String(time).split('.');
		var hours = time[0];

		if (hours == '0') {
			hours = 12;
		} else if (hours.length > 1 && hours >= 12) {
			if (hours > 12 && hours <= 23) {
				hours = hours % 12;
				period = 'pm';
			} else if (hours == 24){
				hours = 12;
				period = 'am';
			} else {
				period = 'pm';
			}

		}

		if (time.length>1) {
			minutes = ':30'; 
		} else {
			minutes = ':00';
		}

		return hours + minutes + period;

	}

	function formatTimeRange(start, end) {

		return start + " - " + end;

	} 

	function timeToNumber(time) {
		var time = time.split(':');

		if(!time[0] && !time[1]) {
			return null;
		}

		if (time[0][0] == '0') {
			number = time[0][1];
		} else {
			number = time[0];
		}

		if (time[1] == '30') {
			number += '.5';
		}

		return Number(number) || 0;

	}

	$("input.slideInput").on('change', function(event){
		var dayOfWeek = event.target.id;
		var timeSpan = $('#' + dayOfWeek + 'Time');

		var startTime = formatTime(event.value.newValue[0]);
		var endTime = formatTime(event.value.newValue[1]);

		timeSpan.text(formatTimeRange(startTime, endTime));
		
	});

	var TIMES = '{"times": [{"day": 0, "start": "08:00", "end": "14:00"},{"day": 1, "start": "10:00", "end": "11:00"},{"day": 2, "start": "16:00", "end": "22:30"},{"day": 3, "start": "08:00", "end": "14:30"},{"day": 4, "start": "", "end": ""},{"day": 5, "start": "", "end": ""},{"day": 6, "start": "", "end": ""}]}';

	var NEW_TIMES = '{"0": [{"end": "12:00", "start": "06:00"}], "2": [{"end": "20:30", "start": "14:00"}], "3": [{"end": "12:30", "start": "06:00"}], "1": [{"end": "09:00", "start": "08:00"}]}';


	function initControls(day, start, end) {
		var daySlider = $('input[type="text"]#' + day);
		var enabled = true;
		var slideInput = $('#' + day + '.slideInput');
		var timeSpan = $('span#' + day + 'Time');

		if(!start || !end) {
			start = 7;
			end = 17;
			enabled = false;
			timeSpan.addClass('hide');		
		} else {
			slideInput.addClass('inputOn');
		}

		daySlider.slider({
			step: .5, 
			min: 0, 
			max: 24, 
			value: [start, end],
			tooltip: 'hide', 
			focus: true,
			enabled: enabled
		});

		$('input[type="checkbox"].' + day ).bootstrapSwitch('state', enabled, enabled);

		timeSpan.text(formatTimeRange(formatTime(start), formatTime(end)));
	} // end initControls


	function parseTimes(day, start, end) {
		var start = timeToNumber(start);
		var end = timeToNumber(end);
		initControls(day, start, end);
	}

	function initTimes(times) {
		for (var el in times) {
			var day = times[el];
			var dayName = DAYS_OF_WEEK[Number(day.day)];
			parseTimes(dayName, day.start, day.end);
		}
	}

	var timesArray = JSON.parse(TIMES).times;
	initTimes(timesArray);


	// Timezones
	var listTz = jstz.olson.timezones;
	var userTz = jstz.determine().name();

	var storedTz = $('#storedTz').text();

	(function populateTimezoneMenu() {
		for (var tz in listTz) {
			var tz = listTz[tz];
			var value = tz;
			$('#timezoneMenu').append('<option value=' + value +'>' +  value + '</option>')
		}
	}());

	if (storedTz) {
		$('div#timezoneDiv select').val(storedTz);
	} else {
		$('div#timezoneDiv select').val(userTz);
	}


	function getCookie(name) {
	    var cookieValue = null;
	    if (document.cookie && document.cookie != '') {
	        var cookies = document.cookie.split(';');
	        for (var i = 0; i < cookies.length; i++) {
	            var cookie = jQuery.trim(cookies[i]);
	            // Does this cookie string begin with the name we want?
	            if (cookie.substring(0, name.length + 1) == (name + '=')) {
	                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
	                break;
	            }
	        }
	    }
	    return cookieValue;
	}

	function displayAlert(message) {
		$('.alert').remove();
		var alert = '<div role="alert" class="alert alert-success"><button type="button" class="close" data-dismiss="alert">&times;</button>' + message + '</div>';
		$('#updateBtn').before(alert);
	}

	function momentHourMinuteParse(number) {
		var time = String(number).split('.');
		var hour = time[0];
		var minute = '';

		if (time.length > 1) {
			minute = '30';
		} 

		return [hour, minute];

	}

	function zeroBasedDay(momentObj) {
		return momentObj.isoWeekday() - 1;
	}

	function convertToUTC(array) {

		var utcDaysTimes = {};

		$(array).each(function(i, el) {
			var dayOfWeekStr = el.id;
			var dayOfWeekInt = DAYS_OF_WEEK.indexOf(el.id);
			var times = el.value.split(',');

			var start = momentHourMinuteParse(timeToNumber(times[0]));
			var end = momentHourMinuteParse(timeToNumber(times[1]));

			var selectedTz = $('div#timezoneDiv select').val();

			var localStart = moment().tz(selectedTz);
			localStart.day(dayOfWeekStr).hour(start[0]).minute(start[1]);

			var localEnd = moment().tz(selectedTz);
			localEnd.day(dayOfWeekStr).hour(end[0]).minute(end[1]);

			var utcStart = localStart.tz('UTC');
			var utcEnd = localEnd.tz('UTC');

			var utcStartDayOfWeek = zeroBasedDay(utcStart);
			var utcEndDayOfWeek = zeroBasedDay(utcEnd);


			// Accounts for converted time ranges spanning more than one day
			if (utcStartDayOfWeek != utcEndDayOfWeek) {

				var priorDayStart = utcStart.day(DAYS_OF_WEEK[utcStartDayOfWeek]).format('HH:mm');
				var priorDayEnd = utcStart.hour(23).minute(59).format('HH:mm');

				if (priorDayStart == priorDayEnd) {
					return;
				}

				if (!utcDaysTimes[utcStartDayOfWeek]) {
					utcDaysTimes[utcStartDayOfWeek] = [];
				}

				utcDaysTimes[utcStartDayOfWeek].push({'start': priorDayStart, 'end': priorDayEnd });


				var currentDayEnd = utcEnd.format('HH:mm');
				var currentDayStart = utcEnd.hour(0).minute(0).format('HH:mm');

				if (currentDayStart == currentDayEnd) {
					return;
				}

				if (!utcDaysTimes[utcEndDayOfWeek]) {
					utcDaysTimes[utcEndDayOfWeek] = [];
				}

				utcDaysTimes[utcEndDayOfWeek].push({'start': currentDayStart, 'end': currentDayEnd });

			} else {

				if (!utcDaysTimes[dayOfWeekInt]) {
					utcDaysTimes[dayOfWeekInt] = [];
				}
				var utcDayStart = utcStart.format('HH:mm');
				var utcDayEnd = utcEnd.format('HH:mm');

				if (utcDayStart == utcDayEnd) {
					return;
				}

				utcDaysTimes[dayOfWeekInt].push({'start': utcDayStart, 'end': utcDayEnd});

			}

		});

		return utcDaysTimes;
	}

	$('#updateBtn').on('click', function(event) {

		var selectedTimeRangesLocal = $('input.inputOn');
		var utcTimes = convertToUTC(selectedTimeRangesLocal);

		$.ajaxSetup({
		    headers: { "X-CSRFToken": getCookie("csrftoken") }
		});

		$.ajax({
			type: 'POST',
			url: '/available/2/',
			data: {'availability': JSON.stringify(utcTimes) },
			success: function(data) {
				displayAlert(data.message);
			}
		})

	});


});
</script>

{% endblock %}